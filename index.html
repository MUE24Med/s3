/* ========================================
   sw.js - Service Worker Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†
   Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0 - Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…Ø³ØªÙ‚Ø±
   ======================================== */

const CACHE_NAME = 'semester-3-cache-20260216-v2';
const urlsToCache = [
    './',
    './index.html',
    './style.css',
    './tracker.js',
    './script.js',
    './javascript/core/config.js',
    './javascript/core/utils.js',
    './javascript/core/navigation.js',
    './javascript/core/group-loader.js',
    './javascript/core/state.js',
    './javascript/ui/pdf-viewer.js',
    './javascript/ui/wood-interface.js',
    './javascript/ui/search-and-eye.js',
    './javascript/ui/ui-controls.js',
    './javascript/ui/scroll-system.js',
    './javascript/features/preload-game.js',
    './javascript/features/svg-processor.js',
    './image/0.webp',
    './image/0.png',
    './image/wood.webp',
    './image/Upper_wood.webp'
];

self.addEventListener('install', event => {
    console.log('ğŸ”§ Service Worker: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¥ØµØ¯Ø§Ø±', CACHE_NAME);
    event.waitUntil(
        caches.open(CACHE_NAME).then(cache =>
            Promise.all(urlsToCache.map(url =>
                cache.add(url).catch(err => {
                    console.warn(`âš ï¸ ÙØ´Ù„ ØªØ®Ø²ÙŠÙ†: ${url}`);
                    return Promise.resolve();
                })
            ))
        ).then(() => {
            console.log('âœ… Service Worker: ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­');
            return self.skipWaiting();
        })
    );
});

self.addEventListener('activate', event => {
    console.log('ğŸš€ Service Worker: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±', CACHE_NAME);
    event.waitUntil(
        caches.keys().then(keys => {
            const deletePromises = keys.map(key => {
                if (key !== CACHE_NAME) {
                    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù ÙƒØ§Ø´ Ù‚Ø¯ÙŠÙ…: ${key}`);
                    return caches.delete(key);
                }
                return null;
            }).filter(Boolean);

            return Promise.all(deletePromises);
        }).then(() => {
            console.log('âœ… Service Worker: ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„');
            return self.clients.claim();
        })
    );
});

self.addEventListener('fetch', event => {
    const url = new URL(event.request.url);

    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
    if (!url.origin.includes(self.location.origin) &&
        !url.origin.includes('github') &&
        !url.origin.includes('raw.githubusercontent') &&
        !url.origin.includes('cdnjs.cloudflare.com')) {
        return;
    }

    // Ù„Ø§ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ SW Ù†ÙØ³Ù‡
    if (url.pathname.includes('sw.js')) return;

    // âœ… Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Cache First Ù…Ø¹ Fallback
    event.respondWith(
        caches.match(event.request).then(cached => {
            if (cached) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                fetch(event.request).then(response => {
                    if (shouldCache(event.request.url) && response && response.status === 200) {
                        caches.open(CACHE_NAME).then(cache => {
                            try { cache.put(event.request, response.clone()); } catch (e) {}
                        });
                    }
                }).catch(() => {});

                return cached;
            }

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙÙŠ Ø§Ù„ÙƒØ§Ø´ØŒ Ù†Ø¬Ù„Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©
            return fetch(event.request).then(response => {
                if (shouldCache(event.request.url) && response && response.status === 200) {
                    caches.open(CACHE_NAME).then(cache => {
                        try { cache.put(event.request, response.clone()); } catch (e) {}
                    });
                }
                return response;
            }).catch(() => {
                // Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØ¡
                if (event.request.destination === 'document') {
                    return new Response(
                        `<!DOCTYPE html>
                        <html dir="rtl" lang="ar">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>ÙˆØ¶Ø¹ Offline</title>
                            <style>
                                body {
                                    font-family: Arial, sans-serif;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    height: 100vh;
                                    margin: 0;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    text-align: center;
                                }
                                .container {
                                    max-width: 500px;
                                    padding: 40px;
                                }
                                h1 { font-size: 48px; margin: 0; }
                                p { font-size: 18px; margin: 20px 0; }
                                button {
                                    background: white;
                                    color: #667eea;
                                    border: none;
                                    padding: 15px 30px;
                                    font-size: 16px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    margin-top: 20px;
                                }
                                button:hover { background: #f0f0f0; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h1>ğŸ”Œ ÙˆØ¶Ø¹ Offline</h1>
                                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>
                                <p>ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                                <button onclick="location.reload()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                            </div>
                        </body>
                        </html>`,
                        { 
                            status: 503, 
                            headers: { 
                                'Content-Type': 'text/html; charset=utf-8',
                                'Cache-Control': 'no-cache'
                            } 
                        }
                    );
                }
                return new Response('Offline', { status: 503 });
            });
        })
    );
});

function shouldCache(url) {
    try {
        const pathname = new URL(url).pathname;

        // Ù„Ø§ Ù†Ø­ÙØ¸ Service Worker Ù†ÙØ³Ù‡
        if (pathname.includes('sw.js')) return false;

        // Ù†Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
        if (pathname.includes('/javascript/')) return true;
        if (pathname.includes('/image/')) return true;
        if (pathname.match(/\.(html|css|js|webp|png|jpg|jpeg|svg|pdf|json)$/)) return true;

        return false;
    } catch (e) {
        return false;
    }
}

self.addEventListener('message', (event) => {
    if (event.data && event.data.action === 'skipWaiting') {
        console.log('â­ï¸ ØªØ®Ø·ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØªÙØ¹ÙŠÙ„ SW Ø§Ù„Ø¬Ø¯ÙŠØ¯');
        self.skipWaiting();
    }

    if (event.data && event.data.action === 'clearCache') {
        console.log('ğŸ—‘ï¸ Ø·Ù„Ø¨ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´');
        event.waitUntil(
            caches.keys()
                .then(names => Promise.all(names.map(n => caches.delete(n))))
                .then(() => {
                    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø´');
                    self.clients.matchAll().then(clients =>
                        clients.forEach(c => c.postMessage({ type: 'CACHE_CLEARED' }))
                    );
                })
        );
    }
});

console.log(`%câœ… Service Worker v2.0 Ù…Ø­Ù…Ù‘Ù„ - Ø§Ù„ÙƒØ§Ø´: ${CACHE_NAME}`, 'color: #00ff00; font-weight: bold;');

// ============================================
// preload-game.js - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¨Ù‚ ÙˆØ§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØµØºØ±Ø©
// Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù† Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ
// ============================================

import { FORMSPREE_URL } from '../core/config.js';
import { getPlayerName, getDeviceId } from '../core/utils.js';

export function initPreloadSystem() {
    const preloadDone = localStorage.getItem('preload_done');
    const preloadScreen = document.getElementById('preload-screen');

    if (!preloadDone && preloadScreen) {
        console.log('ğŸ”„ Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© - ØªÙØ¹ÙŠÙ„ Ø´Ø§Ø´Ø© Preload');

        preloadScreen.classList.remove('hidden');

        const mainContent = [
            document.getElementById('group-selection-screen'),
            document.getElementById('js-toggle-container'),
            document.getElementById('scroll-container'),
            document.getElementById('loading-overlay')
        ];
        mainContent.forEach(el => {
            if (el) el.style.display = 'none';
        });

const filesToLoad = [
    './style.css',
    './tracker.js',
    './script.js',
    './javascript/core/config.js',
    './javascript/core/utils.js',
    './javascript/core/navigation.js',
    './javascript/core/group-loader.js',
    './javascript/core/state.js',
    './javascript/ui/pdf-viewer.js',
    './javascript/ui/wood-interface.js',
    './javascript/ui/search-and-eye.js',
    './javascript/ui/ui-controls.js',
    './javascript/ui/scroll-system.js',
    './javascript/features/preload-game.js',
    './javascript/features/svg-processor.js',
    './image/0.png',
    './image/wood.webp',
    './image/Upper_wood.webp'
];

        const progressBar = document.getElementById('progressBar');
        const fileStatus = document.getElementById('fileStatus');
        const continueBtn = document.getElementById('continueBtn');

        let loadedFiles = 0;
        const totalFiles = filesToLoad.length;

        function updateProgress() {
            const percentage = Math.round((loadedFiles / totalFiles) * 100);
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }

        async function loadFile(url) {
            return new Promise(async (resolve) => {
                try {
                    const cache = await caches.open('semester-3-cache-v1');
                    let cachedResponse = await cache.match(url);

                    if (cachedResponse) {
                        console.log(`âœ… ÙƒØ§Ø´: ${url}`);
                        loadedFiles++;
                        updateProgress();
                        fileStatus.textContent = `âœ” ${url.split('/').pop()}`;
                        resolve();
                        return;
                    }

                    console.log(`ğŸŒ ØªØ­Ù…ÙŠÙ„: ${url}`);
                    const response = await fetch(url);

                    if (response.ok) {
                        await cache.put(url, response.clone());
                        console.log(`ğŸ’¾ Ø­ÙØ¸: ${url}`);
                    }

                    loadedFiles++;
                    updateProgress();
                    fileStatus.textContent = `âœ” ${url.split('/').pop()}`;
                    resolve();

                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£:', url, error);
                    loadedFiles++;
                    updateProgress();
                    resolve();
                }
            });
        }

        async function startLoading() {
            for (const file of filesToLoad) {
                await loadFile(file);
            }

            fileStatus.textContent = 'ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„!';
            continueBtn.style.display = 'block';
        }

        startLoading();

        continueBtn.addEventListener('click', () => {
            console.log('âœ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© preload_done');
            localStorage.setItem('preload_done', 'true');
            localStorage.setItem('last_visit_timestamp', Date.now());

            preloadScreen.classList.add('hidden');

            mainContent.forEach(el => {
                if (el) el.style.display = '';
            });

            window.location.reload();
        });

        // ==================== ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù† ====================
        const gameContainer = document.getElementById('gameContainer');
        const runner = document.getElementById('runner');
        const heartsDisplay = document.getElementById('heartsDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const gameOverlay = document.getElementById('gameOverlay');
        const finalScore = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const leaderboardList = document.getElementById('leaderboardList');
        const lanes = [20, 50, 80];

        let runnerPosition = 0;
        let hearts = 0;
        let score = 0;
        let gameActive = true;
        let fallSpeed = 1.5;
        let activeItems = [];
        let waveCounter = 0;
        let usedLanesInWave = [];
        let spawnInterval = 1800;

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ==========
        function getPersonalRecord() {
            const record = localStorage.getItem('personal_best_score');
            return record ? parseInt(record) : 0;
        }

        function updatePersonalRecord(newScore) {
            const currentRecord = getPersonalRecord();
            if (newScore > currentRecord) {
                localStorage.setItem('personal_best_score', newScore);
                console.log(`ğŸ† Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯: ${newScore} (Ø§Ù„Ø³Ø§Ø¨Ù‚: ${currentRecord})`);
                return true;
            }
            return false;
        }

        function displayPersonalRecord() {
            const record = getPersonalRecord();
            const recordDisplay = document.getElementById('personalRecordValue');
            if (recordDisplay) {
                recordDisplay.textContent = record;
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
        displayPersonalRecord();

        function moveRunner(direction) {
            if (!gameActive) return;
            runnerPosition += direction;
            runnerPosition = Math.max(-1, Math.min(1, runnerPosition));
            runner.style.left = lanes[runnerPosition + 1] + '%';
        }

        leftBtn.addEventListener('click', () => moveRunner(1));
        rightBtn.addEventListener('click', () => moveRunner(-1));

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') moveRunner(-1);
            if (e.key === 'ArrowRight' || e.key === 'd') moveRunner(1);
        });

        function spawnWave() {
            if (!gameActive) return;
            waveCounter++;
            usedLanesInWave = [];
            const itemsInWave = 2;

            for (let i = 0; i < itemsInWave; i++) {
                setTimeout(() => {
                    spawnItem();
                }, i * 100);
            }
        }

        function spawnItem() {
            const rand = Math.random();
            let emoji, type;

            if (rand < 0.15) {
                emoji = 'ğŸ’Š';
                type = 'pill';
            } else if (rand < 0.60) {
                emoji = 'ğŸ¦ ';
                type = 'bacteria';
            } else {
                emoji = 'ğŸ‘¾';
                type = 'virus';
            }

            let availableLanes = [0, 1, 2].filter(lane => !usedLanesInWave.includes(lane));

            if (availableLanes.length === 0) {
                availableLanes = [0, 1, 2];
                usedLanesInWave = [];
            }

            const laneIndex = availableLanes[Math.floor(Math.random() * availableLanes.length)];
            usedLanesInWave.push(laneIndex);

            const item = document.createElement('div');
            item.className = 'falling-item';
            item.textContent = emoji;
            item.dataset.type = type;
            item.dataset.lane = laneIndex;
            item.style.left = lanes[laneIndex] + '%';

            gameContainer.appendChild(item);

            const itemData = {
                element: item,
                y: -40,
                lane: laneIndex,
                type: type
            };

            activeItems.push(itemData);
        }

        function updateGame() {
            if (!gameActive) return;

            activeItems.forEach((itemData, index) => {
                itemData.y += fallSpeed;
                itemData.element.style.top = itemData.y + 'px';

                const containerHeight = gameContainer.offsetHeight;

                if (itemData.y > containerHeight - 100 && itemData.y < containerHeight - 40) {
                    const playerLane = runnerPosition + 1;

                    if (itemData.lane === playerLane) {
                        if (itemData.type === 'pill') {
                            hearts++;
                        } else if (itemData.type === 'bacteria') {
                            hearts--;
                        } else if (itemData.type === 'virus') {
                            hearts -= 1;
                        }

                        heartsDisplay.textContent = hearts;
                        itemData.element.remove();
                        activeItems.splice(index, 1);

                        if (hearts < 0) {
                            endGame();
                        }
                    }
                }

                if (itemData.y > containerHeight) {
                    score++;
                    scoreDisplay.textContent = score;
                    itemData.element.remove();
                    activeItems.splice(index, 1);
                }
            });

            if (gameActive) {
                requestAnimationFrame(updateGame);
            }
        }

        async function fetchGlobalLeaderboard() {
            try {
                console.log('ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©...');
                if (typeof window.storage !== 'undefined') {
                    const result = await window.storage.list('game_score:', true);
                    if (result && result.keys) {
                        const scores = [];
                        for (const key of result.keys) {
                            try {
                                const data = await window.storage.get(key, true);
                                if (data && data.value) {
                                    const parsed = JSON.parse(data.value);
                                    scores.push(parsed);
                                }
                            } catch (err) {
                                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø©:', key);
                            }
                        }
                        scores.sort((a, b) => b.score - a.score);
                        const top5 = scores.slice(0, 5);
                        console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:', top5);
                        return top5;
                    }
                }
                return [];
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:', error);
                return [];
            }
        }

        async function sendScoreToServer(playerName, playerScore, deviceId) {
            try {
                console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±...');
                const timestamp = Date.now();
                const scoreKey = `game_score:${deviceId}_${timestamp}`;
                const scoreData = {
                    name: playerName,
                    score: playerScore,
                    device_id: deviceId,
                    date: new Date().toLocaleDateString('ar-EG'),
                    timestamp: timestamp
                };

                if (typeof window.storage !== 'undefined') {
                    await window.storage.set(scoreKey, JSON.stringify(scoreData), true);
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Storage');
                }

                const formData = new FormData();
                formData.append("Type", "Game_Score");
                formData.append("Player_Name", playerName);
                formData.append("Score", playerScore);
                formData.append("Device_ID", deviceId);
                formData.append("Timestamp", new Date().toLocaleString('ar-EG'));

                navigator.sendBeacon(FORMSPREE_URL, formData);
                console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©');
                return true;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error);
                return false;
            }
        }

        async function displayLeaderboard() {
            const leaderboard = await fetchGlobalLeaderboard();
            const currentPlayerName = getPlayerName();
            const deviceId = getDeviceId();

            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = `
                    <li class="leaderboard-item">
                        <span class="leaderboard-rank">-</span>
                        <span class="leaderboard-name">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</span>
                        <span class="leaderboard-score">-</span>
                    </li>
                `;
                return;
            }

            leaderboardList.innerHTML = leaderboard.map((entry, index) => {
                const topClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                const isCurrentPlayer = entry.device_id === deviceId;
                const currentClass = isCurrentPlayer ? 'current-player' : '';

                return `
                    <li class="leaderboard-item ${topClass} ${currentClass}">
                        <span class="leaderboard-rank">${medal} #${index + 1}</span>
                        <span class="leaderboard-name">${entry.name}</span>
                        <span class="leaderboard-score">${entry.score} â­</span>
                    </li>
                `;
            }).join('');
        }

        async function endGame() {
            gameActive = false;
            finalScore.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score}`;
            gameOverlay.style.display = 'flex';

            const playerName = getPlayerName();
            const deviceId = getDeviceId();

            console.log('ğŸ® Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©:', { playerName, score, deviceId });

            // âœ… ÙØ­Øµ ÙˆØ­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ
            const isNewRecord = updatePersonalRecord(score);
            const recordMessage = document.getElementById('recordMessage');

            if (isNewRecord && recordMessage) {
                recordMessage.innerHTML = 'ğŸ‰ <strong style="color: #FFD700; font-size: 20px;">Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!</strong> ğŸ‰';
                recordMessage.style.marginTop = '15px';
                recordMessage.style.animation = 'pulse 1s infinite';
            } else if (recordMessage) {
                const currentRecord = getPersonalRecord();
                recordMessage.innerHTML = `<span style="color: #888;">Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ: <strong style="color: #fff;">${currentRecord} â­</strong></span>`;
                recordMessage.style.marginTop = '10px';
            }

            await sendScoreToServer(playerName, score, deviceId);
            await displayLeaderboard();
            displayPersonalRecord(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶

            // âœ… ØªØªØ¨Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ tracker.js
            if (typeof window.trackGameScore === 'function') {
                window.trackGameScore(score);
            }
        }

        function restartGame() {
            activeItems.forEach(item => item.element.remove());
            activeItems = [];

            hearts = 0;
            score = 0;
            runnerPosition = 0;
            fallSpeed = 1.5;
            waveCounter = 0;
            spawnInterval = 1800;
            gameActive = true;

            heartsDisplay.textContent = hearts;
            scoreDisplay.textContent = score;
            runner.style.left = lanes[1] + '%';
            gameOverlay.style.display = 'none';

            updateGame();
            startSpawning();
        }

        restartBtn.addEventListener('click', restartGame);

        displayLeaderboard();

        setInterval(() => {
            if (!gameActive) {
                displayLeaderboard();
            }
        }, 30000);

        updateGame();

        let spawnerIntervalId;

        function startSpawning() {
            if (spawnerIntervalId) {
                clearInterval(spawnerIntervalId);
            }

            spawnerIntervalId = setInterval(() => {
                if (gameActive) {
                    spawnWave();
                    waveCounter++;

                    if (waveCounter % 3 === 0) {
                        fallSpeed += 0.15;
                        if (spawnInterval > 800) {
                            spawnInterval -= 100;
                            clearInterval(spawnerIntervalId);
                            startSpawning();
                        }
                    }
                }
            }, spawnInterval);
        }

        startSpawning();
    } else {
        console.log('âœ… Ø²ÙŠØ§Ø±Ø© Ø³Ø§Ø¨Ù‚Ø© - ØªØ®Ø·ÙŠ Preload');
        if (preloadScreen) {
            preloadScreen.classList.add('hidden');
        }
    }
}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>semester-3 | Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</title>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://mue24med.github.io/semester-3/">
  <meta property="og:title" content="semester-3 | Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©">
  <meta property="og:description" content="Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ³ÙƒØ§Ø´Ù† Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© - Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù„Ø«">
  <meta property="og:image" content="https://mue24med.github.io/semester-3/image/0.webp">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="ar_AR">

  <!-- PWA / Mobile -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">
  <meta name="color-scheme" content="only light">

  <!-- Cache Control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="version" content="2025.02.16.FIXED">

  <!-- Performance -->
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
  <link rel="preconnect" href="https://api.github.com" crossorigin>
  <link rel="dns-prefetch" href="https://mozilla.github.io">

  <!-- Icons -->
  <link rel="icon" type="image/png" href="image/0.png">
  <link rel="apple-touch-icon" href="image/0.png">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- ================ Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ================ -->

<!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙØªØ­ -->
<div id="open-method-popup" class="hidden">
  <div class="method-container">
    <div class="method-header">
      <h2>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙØªØ­</h2>
      <span class="method-close" id="method-close-btn">âœ–ï¸</span>
    </div>
    <div class="method-filename" id="method-filename">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</div>
    <div class="method-preview">
      <canvas id="method-preview-canvas"></canvas>
      <div class="method-loading" id="method-loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    <div class="method-buttons">
      <button class="method-btn mozilla-btn" id="open-mozilla-btn">
        <span class="method-btn-icon">ğŸ“„</span>
        <span class="method-btn-text">Mozilla PDF</span>
      </button>
      <button class="method-btn browser-btn" id="open-browser-btn">
        <span class="method-btn-icon">ğŸŒ</span>
        <span class="method-btn-text">Ø§Ù„Ù…ØªØµÙØ­</span>
      </button>
      <button class="method-btn drive-btn" id="open-drive-btn">
        <span class="method-btn-icon">ğŸ’¾</span>
        <span class="method-btn-text">Google Drive</span>
      </button>
    </div>
  </div>
</div>

<!-- ğŸ® Ø´Ø§Ø´Ø© Preload Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<div id="preload-screen" class="hidden">
  <div class="preload-container">
    <div class="notice">
      ğŸ’¡ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© ÙÙ‚Ø· â€” Ø§Ù„Ù…Ù„ÙØ§Øª Ø³ØªÙØ®Ø²Ù† ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹
    </div>
    <div class="logo">ğŸ¥</div>
    <h1>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h1>
    <div class="subtitle">ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹Ø¯ÙˆÙ‰ ğŸ¦  ÙˆØ§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù„Ø§Ø¬ ğŸ’Š</div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>
    <div class="file-status" id="fileStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡...</div>
    <button class="continue-btn" id="continueBtn">Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â¡ï¸</button>

    <!-- ğŸ® Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
    <div class="game-container" id="gameContainer">
      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© -->
      <div class="game-stats">
        <div class="game-stat">â¤ï¸ <span id="heartsDisplay">0</span></div>
        <div class="game-stat">â­ <span id="scoreDisplay">0</span></div>
      </div>

      <!-- ğŸ† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ -->
      <div id="personalRecordDisplay" title="Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ">
        ğŸ† <span id="personalRecordValue">0</span>
      </div>

      <!-- Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
      <div class="runner" id="runner">ğŸ‘¨â€âš•ï¸</div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© -->
      <div class="game-overlay" id="gameOverlay">
        <h2>ğŸ® Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
        <div class="final-score" id="finalScore">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>

        <!-- ğŸ‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ -->
        <div id="recordMessage"></div>

        <button class="restart-btn" id="restartBtn" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨">ğŸ”„</button>

        <!-- ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø£ÙØ¶Ù„ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
        <div class="leaderboard">
          <h3>ğŸ† Ø£ÙØ¶Ù„ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹</h3>
          <ul class="leaderboard-list" id="leaderboardList">
            <li class="leaderboard-item">
              <span class="leaderboard-rank">-</span>
              <span class="leaderboard-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
              <span class="leaderboard-score">-</span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="controls">
      <button class="control-btn" id="leftBtn">â¡ï¸</button>
      <button class="control-btn" id="rightBtn">â¬…ï¸</button>
    </div>
  </div>
</div>

<!-- ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø© (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±) -->
<div id="sessionSummary">
  <h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©</h4>
  <div class="stat">
    <span class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨:</span>
    <span class="stat-value" id="sessionGamesCount">0</span>
  </div>
  <div class="stat">
    <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·:</span>
    <span class="stat-value" id="sessionTotalScore">0</span>
  </div>
  <div class="stat">
    <span class="stat-label">Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·:</span>
    <span class="stat-value" id="sessionHighScore">0</span>
  </div>
  <div class="stat">
    <span class="stat-label">Ø§Ù„Ù…ØªÙˆØ³Ø·:</span>
    <span class="stat-value" id="sessionAvgScore">0</span>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
<div id="group-selection-screen">
  <div id="group-selection-content">
    <img id="main-logo" src="image/0.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠØ©" />
    <h1>Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ</h1>
    <div id="group-buttons">
      <button class="group-btn" data-group="A"><span class="group-letter">A</span><span class="group-label">Group A</span></button>
      <button class="group-btn" data-group="B"><span class="group-letter">B</span><span class="group-label">Group B</span></button>
      <button class="group-btn" data-group="C"><span class="group-letter">C</span><span class="group-label">Group C</span></button>
      <button class="group-btn" data-group="D"><span class="group-letter">D</span><span class="group-label">Group D</span></button>
    </div>
    <p style="color: #888; font-size: 12px; margin-top: 20px;">
      ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø²Ø± "ğŸ”„ Change Group"
    </p>
  </div>
</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
<div id="js-toggle-container" class="top">
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù..." autocomplete="off">
    <span id="search-icon" class="clickable-area">ğŸ”™</span>
  </div>
  <div class="controls-row">
    <span id="move-toggle">â†•ï¸</span>
    <span id="eye-toggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø­Ø«">ğŸ‘ï¸</span>
    <div class="hover-toggle-container">
      <span>Hover</span>
      <label class="switch">
        <input type="checkbox" id="js-toggle" checked>
        <span class="slider round"></span>
      </label>
    </div>
  </div>
</div>

<div id="eye-toggle-standalone" class="top">ğŸ‘ï¸</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loading-overlay">
  <div id="loading-content">
    <img id="splash-image" src="image/0.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„" />
    <h1 id="project-loading-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
    <div id="loader-lights">
      <div class="light-bulb" id="bulb-1"></div>
      <div class="light-bulb" id="bulb-2"></div>
      <div class="light-bulb" id="bulb-3"></div>
      <div class="light-bulb" id="bulb-4"></div>
    </div>
    <div id="legend">
      <div class="legend-item red">Ø£Ø³Ø¦Ù„Ø©</div>
      <div class="legend-item yellow">Ù…Ø­Ø§Ø¶Ø±Ø§Øª</div>
      <div class="legend-item white">Ù…ÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰</div>
      <div class="legend-item purple">Ø¥Ø¬Ø§Ø¨Ø§Øª</div>
      <div class="legend-item green">Ø³ÙƒØ§Ø´Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠ</div>
      <div class="legend-item blue">ÙÙŠØ¯ÙŠÙˆ Ø´Ø±Ø­</div>
    </div>
  </div>
</div>

<!-- Ø¹Ø§Ø±Ø¶ PDF -->
<div id="pdf-overlay" class="hidden">
  <div id="toolbar">
    <div id="pdf-controls">
      <button id="closePdfBtn" class="toolbar-btn">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
      <button id="downloadBtn" class="toolbar-btn">â¬‡ ØªØ­Ù…ÙŠÙ„</button>
      <button id="shareBtn" class="toolbar-btn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
    </div>
  </div>
  <iframe id="pdfFrame" src="" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© PDF -->
<div id="pdf-preview-popup" class="floating-preview">
  <div class="preview-container">
    <div class="preview-header">
      <div class="preview-title" id="preview-filename">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</div>
      <button class="preview-btn preview-open-btn" id="preview-open-btn">ğŸ“„ ÙØªØ­</button>
    </div>
    <div class="preview-canvas-container">
      <div class="preview-loading" id="preview-loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <canvas id="preview-canvas"></canvas>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© -->
<div id="scroll-container">
  <svg id="main-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMinYMin meet">
    <defs></defs>
    <g transform="translate(0,0)" id="files-list-container">
      <image data-src="image/wood.webp" x="0" y="0" width="1024" height="2454" style="pointer-events: none;" />
    </g>
    <g id="dynamic-links-group"></g>
    <g id="group-specific-content"></g>
    <g id="upper-wood-layer" style="pointer-events: none; z-index: 3;">
      <image data-src="image/Upper_wood.webp" x="0" y="0" width="1024" height="250" style="pointer-events: none;" />
    </g>
    <g id="fixed-controls-layer">
      <g id="change-group-btn" style="cursor: pointer;">
        <rect x="120" y="100" width="250" height="50" rx="10"/>
        <text id="group-btn-text" x="245" y="130" text-anchor="middle" dominant-baseline="middle">Change Group ğŸ”„</text>
      </g>
      <g id="preload-btn" style="cursor: pointer;">
        <rect x="387" y="100" width="250" height="50" rx="10"/>
        <text x="512" y="130" text-anchor="middle" dominant-baseline="middle">ğŸ”„ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</text>
      </g>
      <g id="reset-btn" style="cursor: pointer;">
        <rect x="654" y="100" width="250" height="50" rx="10"/>
        <text id="reset-btn-text" x="779" y="130" text-anchor="middle" dominant-baseline="middle">ğŸ”„ test </text>
      </g>
      <g id="back-button-group" style="cursor: pointer;">
        <rect id="back-btn" x="112" y="160" width="800" height="70" rx="15" />
        <text x="512" y="195" id="back-btn-text" text-anchor="middle" dominant-baseline="middle">â¡ï¸ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© â¡ï¸</text>
      </g>
    </g>
  </svg>
</div>

<!-- ======================== Ù†Ù‡Ø§ÙŠØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ======================== -->

<!-- ================ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>

<!-- âœ… Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ â€“ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯Ø© -->
<script type="module" src="script.js"></script>

<!-- âœ… Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(registration => {
        console.log('âœ… Service Worker Ù…Ø³Ø¬Ù„');
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              if (confirm('ğŸ”„ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŸ')) {
                newWorker.postMessage({ action: 'skipWaiting' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(err => console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ SW:', err));
  });

  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) {
      refreshing = true;
      window.location.reload();
    }
  });
}
</script>

<!-- âœ… ÙØ­Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† GitHub -->
<script>
async function checkForUpdates() {
  try {
    const lastCheck = localStorage.getItem('last_update_check');
    const now = Date.now();
    if (lastCheck && (now - parseInt(lastCheck)) < 300000) return;

    const response = await fetch(
      'https://api.github.com/repos/MUE24Med/s3/commits/main',
      { cache: 'no-store', headers: { 'Accept': 'application/vnd.github.v3+json' } }
    );
    if (!response.ok) return;
    const data = await response.json();
    const latestSha = data.sha.substring(0, 7);
    const lastSha = localStorage.getItem('last_commit_sha');

    if (!lastSha) {
      localStorage.setItem('last_commit_sha', latestSha);
      localStorage.setItem('last_update_check', now.toString());
      return;
    }

    if (lastSha !== latestSha) {
      console.log('ğŸ†• ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­:', latestSha);
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));
      localStorage.setItem('last_commit_sha', latestSha);
      localStorage.removeItem('preload_done');
      window.location.reload(true);
    } else {
      localStorage.setItem('last_update_check', now.toString());
    }
  } catch (error) {
    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:', error);
  }
}
window.addEventListener('load', checkForUpdates);
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) checkForUpdates();
});
</script>

<!-- âœ… ÙƒÙˆØ¯ Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ØµØ­Ø­ -->
<script>
// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
setInterval(() => {
  if (typeof updateSessionSummaryDisplay === 'function') {
    updateSessionSummaryDisplay();
  }
}, 10000);

// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡
document.getElementById('sessionSummary')?.addEventListener('click', function() {
  this.classList.remove('show');
});
</script>

</body>
</html>

/* ========================================
   COMPLETE STYLE.CSS - FIXED VERSION
   ======================================== */

/* [000] Ø´Ø§Ø´Ø© Preload */
#preload-screen {
  position: fixed;
  inset: 0;
  z-index: 5;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 10px;
  transition: opacity 0.3s ease, transform 0.3s ease;
  overflow-y: auto;
}

#preload-screen.hidden {
  opacity: 0;
  transform: scale(0.95);
  pointer-events: none;
}

.preload-container {
  width: 100%;
  max-width: 450px;
  background: rgba(0, 0, 0, 0.85);
  border-radius: 20px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
  max-height: 95vh;
  overflow-y: auto;
}

.preload-container .notice {
  font-size: 12px;
  background: rgba(46, 204, 113, 0.15);
  color: #2ecc71;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 15px;
  border: 1px solid rgba(46, 204, 113, 0.3);
}

.preload-container .logo {
  font-size: 50px;
  margin-bottom: 10px;
}

.preload-container h1 {
  font-size: 24px;
  margin: 10px 0;
  color: #3498db;
}

.preload-container .subtitle {
  font-size: 14px;
  opacity: 0.8;
  margin-bottom: 15px;
}

.progress-container {
  background: #222;
  border-radius: 10px;
  overflow: hidden;
  height: 25px;
  margin: 15px 0;
  position: relative;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #3498db, #2ecc71);
  transition: width 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 13px;
}

.file-status {
  font-size: 13px;
  background: rgba(255, 255, 255, 0.1);
  padding: 8px;
  border-radius: 8px;
  margin: 10px 0;
  min-height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.continue-btn {
  display: none;
  margin: 15px 0;
  padding: 12px 30px;
  width: 100%;
  border: none;
  border-radius: 25px;
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  color: white;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
}

.continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 7px 20px rgba(46, 204, 113, 0.5);
}

.continue-btn:active {
  transform: translateY(0);
}

.game-container {
  background: linear-gradient(180deg, #1a1a2e, #0f0f1e);
  height: 500px;
  border-radius: 15px;
  position: relative;
  overflow: hidden;
  margin: 15px 0;
  border: 2px solid rgba(52, 152, 219, 0.3);
}

.game-stats {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  z-index: 1;
  pointer-events: none;
}

.game-stat {
  background: rgba(0, 0, 0, 0.7);
  padding: 8px 15px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: bold;
  backdrop-filter: blur(5px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.runner {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 35px;
  z-index: 1;
  transition: left 0.2s ease;
}

.falling-item {
  position: absolute;
  top: -40px;
  font-size: 30px;
  z-index: 1;
}

.game-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.95);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 2;
  backdrop-filter: blur(5px);
}

.game-overlay h2 {
  font-size: 28px;
  margin-bottom: 10px;
  color: #e74c3c;
}

.final-score {
  font-size: 20px;
  margin: 10px 0;
  color: #3498db;
}

.restart-btn {
  font-size: 40px;
  background: none;
  border: none;
  color: #2ecc71;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.restart-btn:hover {
  transform: scale(1.2);
}

.controls {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.control-btn {
  flex: 1;
  padding: 15px;
  border: none;
  border-radius: 15px;
  background: linear-gradient(135deg, #3498db, #2980b9);
  color: white;
  font-weight: bold;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
}

.control-btn:active {
  transform: scale(0.95);
}

.leaderboard {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 10px;
  margin-top: 15px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  max-height: 300px;
  overflow-y: auto;
}

.leaderboard h3 {
  font-size: 16px;
  margin-bottom: 10px;
  color: #f39c12;
}

.leaderboard-list {
  list-style: none;
  padding: 0;
}

.leaderboard-item {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  margin: 5px 0;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  font-size: 14px;
}

.leaderboard-rank {
  font-weight: bold;
  color: #3498db;
  min-width: 30px;
}

.leaderboard-name {
  flex: 1;
  text-align: center;
  color: #ecf0f1;
}

.leaderboard-score {
  font-weight: bold;
  color: #2ecc71;
  min-width: 50px;
  text-align: right;
}

.leaderboard-item.top1 .leaderboard-rank { color: #f39c12; }
.leaderboard-item.top2 .leaderboard-rank { color: #95a5a6; }
.leaderboard-item.top3 .leaderboard-rank { color: #cd7f32; }

.leaderboard-item.current-player {
  background: rgba(255, 204, 0, 0.2) !important;
  border: 2px solid rgba(255, 204, 0, 0.5) !important;
  box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
  transform: scale(1.02);
}

.leaderboard-item.current-player .leaderboard-name {
  color: #ffcc00 !important;
  font-weight: 700;
}

.leaderboard-item.current-player .leaderboard-score {
  color: #ffcc00 !important;
  text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
}

.no-scores {
  color: #999;
  text-align: center;
  padding: 30px;
  font-size: 16px;
}

@media (max-width: 480px) {
  .game-container { height: 250px; }
  .runner { font-size: 30px; }
  .falling-item { font-size: 25px; }
}

/* [000-B] Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙØªØ­ - Ù…Ø­Ø¯Ø«Ø© */
#open-method-popup {
  position: fixed;
  inset: 0;
  z-index: 4;
  background: rgba(0, 0, 0, 0.75); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

#open-method-popup.active {
  display: flex !important;
}

.method-container {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  border-radius: 20px;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 0 2px rgba(255, 204, 0, 0.3);
  border: 2px solid #ffcc00;
}

.method-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 204, 0, 0.3);
}

.method-header h2 {
  color: #ffcc00;
  font-size: 20px;
  margin: 0;
}

.method-close {
  font-size: 24px;
  cursor: pointer;
  color: #fff;
  transition: transform 0.2s;
  background: rgba(255, 0, 0, 0.2);
  border-radius: 50%;
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.method-close:hover {
  transform: scale(1.2);
  background: rgba(255, 0, 0, 0.4);
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
.method-preview {
  background: #000;
  border-radius: 10px;
  min-height: 300px;
  max-height: 50vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-bottom: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ù„Ø¥Ù„ØµØ§Ù‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
  position: relative;
}

#method-preview-canvas {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

.method-loading {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.8);
  color: #ffcc00;
  font-size: 18px;
}

.method-loading.hidden {
  display: none;
}

.method-filename {
  text-align: center;
  color: #ffcc00;
  font-size: 14px;
  font-weight: bold;
  margin: 10px 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø« - ØµÙ ÙˆØ§Ø­Ø¯ ØµØºÙŠØ± */
.method-buttons {
  display: flex;
  flex-direction: row;
  gap: 8px;
  padding: 10px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 0 0 10px 10px;
}

.method-btn {
  flex: 1;
  padding: 10px 8px;
  border: 2px solid;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: bold;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  min-width: 0;
}

.method-btn-icon {
  font-size: 20px;
}

.method-btn-text {
  font-size: 11px;
  text-align: center;
  line-height: 1.2;
}

.mozilla-btn {
  background: rgba(255, 69, 0, 0.2);
  border-color: #ff4500;
  color: #ff4500;
}

.mozilla-btn:hover {
  background: rgba(255, 69, 0, 0.4);
  transform: translateY(-2px);
}

.browser-btn {
  background: rgba(52, 152, 219, 0.2);
  border-color: #3498db;
  color: #3498db;
}

.browser-btn:hover {
  background: rgba(52, 152, 219, 0.4);
  transform: translateY(-2px);
}

.drive-btn {
  background: rgba(76, 175, 80, 0.2);
  border-color: #4caf50;
  color: #4caf50;
}

.drive-btn:hover {
  background: rgba(76, 175, 80, 0.4);
  transform: translateY(-2px);
}

.method-btn:active {
  transform: translateY(0) scale(0.98);
}

/* [001] Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
*, *::before, *::after {
  box-sizing: border-box !important;
  -webkit-tap-highlight-color: transparent;
}

:root {
  color-scheme: only light !important;
  --color-q: red;
  --color-v: blue;
  --color-i: white;
  --color-a: purple;
  --color-s: green;
  --color-l: yellow;
  --color-is: #c8ff8e;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100svh;
  width: 100vw;
  overflow: hidden;
  background-color: black !important;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: white;
}

#scroll-container {
  width: 100vw;
  height: 100svh;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  direction: ltr;
  scrollbar-width: thin;
  scrollbar-color: #444 black;
}

#main-svg {
  height: 100%;
  width: auto;
  display: block;
  transition: opacity 0.2s ease-out;
  opacity: 0;
  visibility: hidden;
}

#main-svg.loaded {
  opacity: 1;
  visibility: visible;
}

/* [002] Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© */
.m {
  fill: transparent;
  stroke: transparent;
  stroke-width: 2px;
  transform-origin: center center;
  transition: filter 0.2s ease, stroke-width 0.2s ease;
  cursor: pointer;
}

.q { stroke: var(--color-q); }
.v { stroke: var(--color-v); }
.i { stroke: var(--color-i); }
.a { stroke: var(--color-a); }
.s { stroke: var(--color-s); }
.l { stroke: var(--color-l); }
.is { stroke: var(--color-is); }

/* [003] Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© */
#group-selection-screen {
  height: 100svh;
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3;
  transition: opacity 0.3s ease-out, transform 0.3s ease-out;
}

#group-selection-screen.hidden {
  opacity: 0;
  transform: scale(0.9);
  pointer-events: none;
}

#group-selection-content {
  text-align: center;
  width: 90%;
  max-width: 600px;
  transform: scale(0.85);
}

#main-logo {
  width: 300px;
  max-width: 80vw;
  height: auto;
  margin-bottom: 30px;
  border-radius: 15px;
  box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
}

#group-selection-content h1 {
  color: #ffcc00;
  font-size: clamp(1.2rem, 4vw, 2rem);
  margin-bottom: 40px;
  text-transform: uppercase;
  letter-spacing: 3px;
}

#group-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  padding: 0 20px;
}

.group-btn {
  background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
  border: 2px solid #444;
  border-radius: 15px;
  padding: 30px 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.group-btn:hover {
  border-color: #ffcc00;
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(255, 204, 0, 0.3);
}

.group-btn:active {
  transform: translateY(-2px) scale(0.98);
}

.group-letter {
  font-size: 3rem;
  font-weight: bold;
  color: #ffcc00;
}

.group-label {
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  color: #ccc;
  text-transform: uppercase;
  letter-spacing: 2px;
}

@media (max-width: 480px) {
  #group-buttons {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  .group-letter { font-size: 2.5rem; }
  #main-logo { width: 200px; }
}

/* [004] Ø¹Ø§Ø±Ø¶ PDF */
#pdf-overlay {
  height: 100svh;
  transition: transform 0.2s ease, opacity 0.2s ease;
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 4;
  display: flex;
  flex-direction: column;
}

#pdf-overlay.hidden {
  transform: translateY(100%);
  pointer-events: none;
}

#toolbar {
  height: 50px;
  background: #333;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 10px;
  border-bottom: 1px solid #555;
}

#pdf-controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

#pdfFrame {
  flex: 1;
  width: 100%;
  border: none;
  background: #fff;
}

.toolbar-btn, .pdf-control-btn {
  background: #555;
  color: white;
  border: 1px solid #777;
  padding: 5px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

#expand-toolbar-btn {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
}

#expand-toolbar-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6);
}

#expand-toolbar-btn:active {
  transform: scale(0.95);
}

#pdf-overlay.fullscreen-mode #pdf-controls {
  opacity: 0;
  pointer-events: none;
  transform: translateY(-100%);
  transition: all 0.3s ease;
}

#pdf-overlay.fullscreen-mode:hover #pdf-controls {
  opacity: 1;
  pointer-events: all;
  transform: translateY(0);
}

#pdf-overlay.fullscreen-mode #expand-toolbar-btn {
  background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
}

/* [005] Ù†Ø§ÙØ°Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© PDF */
#pdf-preview-popup {
  position: fixed;
  inset: 0;
  z-index: 3;
  background: rgba(0, 0, 0, 0.75); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

#pdf-preview-popup.active {
  display: flex;
}

.preview-container {
  background: #1a1a1a;
  border-radius: 20px;
  padding: 20px;
  max-width: 90vw;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 50px rgba(255, 204, 0, 0.5);
  border: 2px solid #ffcc00;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 204, 0, 0.3);
}

.preview-title {
  color: #ffcc00;
  font-size: 18px;
  font-weight: bold;
  flex: 1;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.preview-btn {
  background: rgba(255, 204, 0, 0.2);
  border: 1px solid #ffcc00;
  color: white;
  padding: 8px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.preview-btn:hover {
  background: rgba(255, 204, 0, 0.4);
  transform: scale(1.05);
}

.preview-canvas-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background: #000;
  border-radius: 10px;
  position: relative;
  min-height: 400px;
}

#preview-canvas {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

.preview-loading {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.8);
  color: #ffcc00;
  font-size: 20px;
  z-index: 1;
}

.preview-loading.hidden {
  display: none;
}

.preview-hint {
  margin-top: 10px;
  text-align: center;
  color: rgba(255, 204, 0, 0.8);
  font-size: 11px;
}

/* [006] Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
#loading-overlay {
  position: fixed;
  height: 100svh;
  inset: 0;
  background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2;
  transition: opacity 0.3s ease-out;
  opacity: 0;
  pointer-events: none;
}

#loading-overlay.active {
  display: flex;
  opacity: 1;
  pointer-events: all;
}

#loading-content {
  text-align: center;
  width: 90%;
  max-width: 600px;
}

#splash-image {
  width: 400px;
  max-width: 85vw;
  height: auto;
  display: block;
  margin: -60px auto 10px auto;
  border-radius: 15px;
}

#loading-content h1 {
  color: #ffcc00;
  margin: 10px 0;
  font-size: 1.8rem;
  text-transform: uppercase;
  letter-spacing: 2px;
}

#loader-lights {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 20px 0;
}

.light-bulb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background-color: #222;
  border: 1px solid #444;
  transition: all 0.2s ease;
}

#bulb-1.on {
  background-color: #4dff88;
  box-shadow: 0 0 15px #4dff88;
  border-color: #fff;
}

#bulb-2.on {
  background-color: #ffff4d;
  box-shadow: 0 0 15px #ffff4d;
  border-color: #fff;
}

#bulb-3.on {
  background-color: #ffaa00;
  box-shadow: 0 0 15px #ffaa00;
  border-color: #fff;
}

#bulb-4.on {
  background-color: #ff4d4d;
  box-shadow: 0 0 15px #ff4d4d;
  border-color: #fff;
}

#legend {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 30px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #eee;
  font-size: 13px;
}

.legend-item::before {
  content: "";
  width: 12px;
  height: 12px;
  border-radius: 3px;
  background-color: var(--item-color);
  box-shadow: 0 0 10px var(--item-color);
  flex-shrink: 0;
}

.legend-item.red { --item-color: var(--color-q); }
.legend-item.blue { --item-color: var(--color-v); }
.legend-item.white { --item-color: var(--color-i); }
.legend-item.purple { --item-color: var(--color-a); }
.legend-item.green { --item-color: var(--color-s); }
.legend-item.yellow { --item-color: var(--color-l); }
.legend-item.is { --item-color: var(--color-is); }

/* [007] Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
#js-toggle-container {
  position: fixed;
  right: 20px;
  z-index: 3;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: white;
  background-color: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(8px);
  padding: 8px;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  width: 180px;
  transition: all 0.2s ease;
  pointer-events: auto;
}

#js-toggle-container.fully-hidden {
  display: none !important;
  pointer-events: none !important;
  opacity: 0 !important;
  visibility: hidden !important;
}

#js-toggle-container.top { top: 20px; }
#js-toggle-container.bottom { bottom: 20px; }

#search-container {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
}

#search-input {
  padding: 8px 10px 8px 45px;
  border: 1px solid #444;
  border-radius: 5px;
  width: 100%;
  height: 36px;
  background: #222;
  color: white;
  font-size: 13px;
}

.clickable-area {
  position: absolute;
  left: 2px;
  top: 50%;
  transform: translateY(-50%);
  width: 40px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  z-index: 1;
}

.controls-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  width: 100%;
  border-top: 1px solid rgba(255,255,255,0.1);
  padding-top: 8px;
}

#move-toggle, #eye-toggle {
  cursor: pointer;
  user-select: none;
  padding: 6px;
  font-size: 16px;
  transition: all 0.2s ease;
  opacity: 0.8;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  min-width: 32px;
  min-height: 32px;
}

#eye-toggle {
  font-size: 14px;
  min-width: 28px;
  min-height: 28px;
}

#move-toggle:hover, #eye-toggle:hover {
  opacity: 1;
  transform: scale(1.15);
  background: rgba(255, 255, 255, 0.1);
}

.hover-toggle-container {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: auto;
}

.switch {
  position: relative;
  display: inline-block;
  width: 36px;
  height: 18px;
}

.switch input { opacity: 0; width: 0; height: 0; }

.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #444;
  transition: 0.2s;
  border-radius: 18px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 12px;
  width: 12px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.2s;
  border-radius: 50%;
}

input:checked + .slider { background-color: #2196F3; }
input:checked + .slider:before { transform: translateX(18px); }

#eye-toggle-standalone {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2;
  width: 40px;
  height: 40px;
  background-color: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(8px);
  border-radius: 50%;
  border: 1px solid rgba(255, 255, 255, 0.2);
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: grab;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  user-select: none;
  touch-action: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#eye-toggle-standalone.dragging {
  cursor: grabbing;
  transform: scale(1.1);
  box-shadow: 0 8px 24px rgba(255, 204, 0, 0.6);
  z-index: 3;
}

#eye-toggle-standalone:hover:not(.dragging) {
  transform: scale(1.15);
  background-color: rgba(0, 0, 0, 1);
}

/* [008] Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ø¨ØªØ© */
#fixed-controls-layer {
  z-index: 3;
  pointer-events: none;
}

#reset-btn, #change-group-btn, #back-button-group, #preload-btn {
  cursor: pointer;
  pointer-events: auto;
}

#reset-btn rect, #change-group-btn rect, #back-btn, #preload-btn rect {
  transition: filter 0.2s ease, fill 0.2s ease;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.8));
  stroke: none;
  pointer-events: auto;
}

#reset-btn:hover rect, #change-group-btn:hover rect, 
#back-button-group:hover rect, #preload-btn:hover rect {
  filter: drop-shadow(0 6px 15px rgba(0, 0, 0, 0.9)) 
          drop-shadow(0 0 25px rgba(255, 204, 0, 0.8));
}

#reset-btn text, #change-group-btn text, #back-btn-text, 
#preload-btn text, #group-btn-text {
  pointer-events: none;
  user-select: none;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 900;
  font-size: 26px;
  fill: #ffffff;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.9));
}

#back-btn-text { font-size: 30px; }

#reset-btn rect, #change-group-btn rect, #preload-btn rect, #back-btn {
  fill: #000000;
}

#reset-btn:hover rect, #change-group-btn:hover rect, 
#preload-btn:hover rect, #back-button-group:hover #back-btn {
  fill: #1a1a1a;
}

/* [009] Utilities */
.label-bg { rx: 3; ry: 3; opacity: 0.9; }
.rect-label { font-weight: bold; pointer-events: none; }

img, image, svg, rect {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

.scrollable-content {
  transition: transform 0.1s ease-out;
  cursor: grab;
  user-select: none;
}

.scrollable-content:active {
  cursor: grabbing;
}

.scrollable-content.grabbing {
  cursor: grabbing !important;
}

.scroll-handle {
  transition: y 0.1s ease-out;
}

.scroll-handle:hover {
  fill: #ffd54f;
}

#scroll-container::-webkit-scrollbar {
  height: 8px;
}

#scroll-container::-webkit-scrollbar-track {
  background: #000;
}

#scroll-container::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 4px;
}

.wood-folder-group,
.wood-file-group {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

.wood-folder-group:active,
.wood-file-group:active {
  opacity: 0.7;
}

@keyframes pulseGlow {
  0%, 100% {
    box-shadow: 0 0 20px rgba(255, 204, 40, 0.5);
  }
  50% {
    box-shadow: 0 0 40px rgba(255, 204, 40, 0.8);
  }
}

.long-press-active {
  animation: pulseGlow 1s infinite;
}

.fully-hidden {
  display: none !important;
  opacity: 0 !important;
  visibility: hidden !important;
  pointer-events: none !important;
  z-index: -1 !important;
}

@media (max-width: 768px) {
  #reset-btn text, #change-group-btn text, 
  #preload-btn text, #group-btn-text { font-size: 22px; }
  #back-btn-text { font-size: 26px; }

  .method-container {
    padding: 20px;
  }

  .method-header h2 {
    font-size: 18px;
  }

  .method-preview {
    height: 250px;
  }

  .method-btn {
    padding: 8px 6px;
    font-size: 12px;
  }

  .method-btn-icon {
    font-size: 18px;
  }
}

@media (max-width: 480px) {
  #reset-btn text, #change-group-btn text, 
  #preload-btn text, #group-btn-text { font-size: 19px; }
  #back-btn-text { font-size: 23px; }

  .method-container {
    padding: 15px;
    max-width: 95%;
  }

  .method-header h2 {
    font-size: 16px;
  }

  .method-preview {
    height: 200px;
  }

  .method-btn {
    padding: 8px 4px;
    font-size: 11px;
  }

  .method-btn-icon {
    font-size: 16px;
  }

  .method-filename {
    font-size: 12px;
  }
}

@media print {
  #js-toggle-container, #loading-overlay, #group-selection-screen,
  #pdf-overlay, #preload-screen, #pdf-preview-popup, #open-method-popup {
    display: none !important;
  }
}